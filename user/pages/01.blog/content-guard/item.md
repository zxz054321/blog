---
title: '内容安全卫士'
media_order: 'welcome.png,login.png,dashboard.png'
date: '15:00 12/22/2017'
taxonomy:
    category:
        - blog
    tag:
        - work
author: Abel
---

内容安全卫士是广东省数字政府工程的一个项目，是业务部门从南方监测云独立出来的一个产品，主要功能是监控并辅助修正政务类网站的内容错误、用法错误。

===

此项目由业务部门发起，并提供原型图、设计资源，研发部门调配1名产品、1名前端和1名后端。其中我负责整个项目的架构、静态前端、后端及运维，前端负责编写前端组件、适配IE8及AJAX交互。

![欢迎页面](welcome.png)

## 需求与选型

业务部门并未完全敲定产品细节，这意味着在开发过程中，需求可能会有多次调整。由于竞品开普云准备IPO带来的压力，业务方要求产品在短期内上线。

因此技术选型以**又快又稳、保持灵活**为目标。

- 前端需要兼容IE8，前端框架选用Bootstrap 3，可以在兼容IE8的同时快速搭建UI
- 后端框架选用Laravel 5，可以快速开发出健壮的服务端程序
- 运行环境为LNMP组合，其中数据库选用MySQL 5.6，以保持在不同环境的最大兼容性

![登录页面](login.png)

## 编码过程

### 数据层

#### 库表结构

数据库是一个系统的根基，根基不正，修建上层就要事倍功半，而且还不稳固。本项目的核心数据都是通过监测云内部API获取，并附加一些信息储存。因此数据库只储存必要的信息，语义化字段名称以增强可读性。

#### 模型

所有业务相关的表均用Eloquent模型表示，与数据库直接相关的描述、定义、函数均定义在模型层。

### API

因工作中经常需要在PHP层代理API请求，故将相关逻辑抽离出来，做成一个Composer包发布。

Github: https://github.com/zxz054321/api-proxy

### Repository层

Repository是一种设计模式，可以更好地组织代码，对逻辑进行进一步的分层，使项目代码更为清晰。

其中直接调用监测云内部API的代码封装为MonitorApiRepository，将API调用抽象为类的一个个行为。

在此基础上作进一步封装，把监测站点相关的操作封装为SiteRepository，以便在不同的类、控制器、命令行当中复用。

### 控制器层

控制器是MVC类框架的经典层级，前面为保持项目代码简单清晰，主要的业务逻辑都封装在了Repository层，因此控制器只需负责响应HTTP请求、调用Repository获得数据形成响应。

### 路由层

路由负责把请求映射到不同控制器进行处理，并通过路由分组对Web页面请求、API请求作了相应优化。

### 命令层

由于业务方暂不需要后台，因此用户管理、站点管理都通过命令行实现。命令跟控制器类似，只需负责CLI交互并调用Repository完成工作。

## 部署到服务器

集团内部操作域名需要作跨部门申请，很麻烦。因此部门的项目都是用一台Nginx服务器把相应域名的请求映射到不同的服务器上。部门没有采购或搭建自动运维、自动部署服务，因此生产服务器是手工安装LNMP组合，通过Git进行代码同步。

![仪表盘](dashboard.png)

至此，内容安全卫士正式上线，广东省人民政府是为首批用户。